import { describe, it, expect, beforeEach, vi } from 'vitest';
import { findBuildScript } from '../../storage/db-store.js';
import * as fileStore from '../../storage/db-store.js';
import type { BuildScript, PlanState, WorkspaceMeta } from '../../types/index.js';

/**
 * Unit Tests for findBuildScript()
 * 
 * Extracted to its own file because findBuildScript was moved to
 * build-script-utils.ts (separate from file-store.ts) so that
 * vi.mock can properly intercept its internal calls to getBuildScripts,
 * getWorkspace, and getPlanState.
 */

// Mock file-store so findBuildScript's imports are intercepted
vi.mock('../../storage/db-store.js');

const mockWorkspaceId = 'ws_test_buildscripts_123';
const mockPlanId = 'plan_test_abc456';

describe('findBuildScript()', () => {

  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should return direct match when script exists in workspace scope', async () => {
    const scriptId = 'script_ws_match';
    const script: BuildScript = {
      id: scriptId,
      name: 'Workspace Script',
      description: '',
      command: 'echo test',
      directory: '/test',
      workspace_id: mockWorkspaceId,
      created_at: '2024-01-01'
    };

    vi.mocked(fileStore.getBuildScripts).mockResolvedValue([script]);

    const result = await findBuildScript(mockWorkspaceId, scriptId);

    expect(result).toEqual(script);
    expect(fileStore.getBuildScripts).toHaveBeenCalledWith(mockWorkspaceId, undefined);
  });

  it('should search plan scripts when plan_id is omitted', async () => {
    const scriptId = 'script_plan_match';
    const planScript: BuildScript = {
      id: scriptId,
      name: 'Plan Script',
      description: '',
      command: 'echo plan',
      directory: '/test',
      workspace_id: mockWorkspaceId,
      plan_id: mockPlanId,
      created_at: '2024-01-01'
    };

    vi.mocked(fileStore.getBuildScripts).mockResolvedValue([]);
    vi.mocked(fileStore.getWorkspace).mockResolvedValue({
      workspace_id: mockWorkspaceId,
      path: '/test/workspace',
      name: 'Test Workspace',
      registered_at: '2024-01-01',
      last_accessed: '2024-01-01',
      active_plans: [mockPlanId],
      archived_plans: [],
      indexed: false
    } as WorkspaceMeta);
    vi.mocked(fileStore.getPlanState).mockResolvedValue({
      id: mockPlanId,
      workspace_id: mockWorkspaceId,
      title: 'Plan',
      description: 'Plan description',
      priority: 'low',
      category: 'advisory',
      status: 'active',
      current_phase: 'phase',
      current_agent: 'Executor',
      created_at: '2024-01-01',
      updated_at: '2024-01-01',
      steps: [],
      build_scripts: [planScript]
    } as PlanState);

    const result = await findBuildScript(mockWorkspaceId, scriptId);

    expect(result).toEqual(planScript);
    expect(fileStore.getPlanState).toHaveBeenCalledWith(mockWorkspaceId, mockPlanId);
  });

  it('should honor plan_id scope when provided', async () => {
    const scriptId = 'script_scoped';
    const script: BuildScript = {
      id: scriptId,
      name: 'Scoped Script',
      description: '',
      command: 'echo scoped',
      directory: '/test',
      workspace_id: mockWorkspaceId,
      plan_id: mockPlanId,
      created_at: '2024-01-01'
    };

    vi.mocked(fileStore.getBuildScripts).mockResolvedValue([script]);

    const result = await findBuildScript(mockWorkspaceId, scriptId, mockPlanId);

    expect(result).toEqual(script);
    expect(fileStore.getBuildScripts).toHaveBeenCalledWith(mockWorkspaceId, mockPlanId);
  });

  it('should return null when script not found anywhere', async () => {
    vi.mocked(fileStore.getBuildScripts).mockResolvedValue([]);
    vi.mocked(fileStore.getWorkspace).mockResolvedValue({
      workspace_id: mockWorkspaceId,
      path: '/test/workspace',
      name: 'Test',
      registered_at: '2024-01-01',
      last_accessed: '2024-01-01',
      active_plans: [],
      archived_plans: [],
      indexed: false
    } as WorkspaceMeta);

    const result = await findBuildScript(mockWorkspaceId, 'nonexistent');

    expect(result).toBeNull();
  });

  it('should return null when workspace not found', async () => {
    vi.mocked(fileStore.getBuildScripts).mockResolvedValue([]);
    vi.mocked(fileStore.getWorkspace).mockResolvedValue(null);

    const result = await findBuildScript(mockWorkspaceId, 'nonexistent');

    expect(result).toBeNull();
  });
});
