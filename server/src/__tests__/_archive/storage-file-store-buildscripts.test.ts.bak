import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import * as fileStore from '../../storage/db-store.js';
import type { BuildScript, WorkspaceMeta } from '../../types/index.js';

/**
 * Unit Tests for BuildScript Storage Methods
 * 
 * These tests verify the BuildScript interface and error handling.
 * Full integration tests for file operations are in the MCP tool tests.
 * 
 * Note: The server-side execution engine (runBuildScript) was removed in Phase 10.
 * Build scripts are now resolved and returned for terminal execution by agents.
 * findBuildScript tests are in find-build-script.test.ts (extracted for proper mocking).
 * Comprehensive tests are in:
 * - memory-plan-buildscripts.test.ts (MCP tool level)
 */

const mockWorkspaceId = 'ws_test_buildscripts_123';
const mockPlanId = 'plan_test_abc456';

describe('FileStore: BuildScript Storage Methods', () => {
  
  beforeEach(() => {
    vi.clearAllMocks();
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  // =========================================================================
  // getBuildScripts() - Test via spying on getWorkspace/getPlanState
  // =========================================================================

  describe('getBuildScripts()', () => {
    
    it('should return empty array when workspace returns null', async () => {
      vi.spyOn(fileStore, 'getWorkspace').mockResolvedValue(null);

      const scripts = await fileStore.getBuildScripts(mockWorkspaceId);
      
      expect(scripts).toEqual([]);
    });

    it('should return empty array when workspace has no build scripts', async () => {
      const mockWorkspace: WorkspaceMeta = {
        workspace_id: mockWorkspaceId,
        path: '/test/workspace',
        name: 'Test Workspace',
        registered_at: '2024-01-15T10:00:00Z',
        last_accessed: '2024-01-20T14:30:00Z',
        active_plans: [],
        archived_plans: [],
        indexed: false,
        // No workspace_build_scripts property
      };

      vi.spyOn(fileStore, 'getWorkspace').mockResolvedValue(mockWorkspace);

      const scripts = await fileStore.getBuildScripts(mockWorkspaceId);
      
      expect(scripts).toEqual([]);
    });

    it('should handle plan returning null', async () => {
      const mockWorkspace: WorkspaceMeta = {
        workspace_id: mockWorkspaceId,
        path: '/test/workspace',
        name: 'Test Workspace',
        registered_at: '2024-01-15T10:00:00Z',
        last_accessed: '2024-01-20T14:30:00Z',
        active_plans: [],
        archived_plans: [],
        indexed: false,
      };

      vi.spyOn(fileStore, 'getWorkspace').mockResolvedValue(mockWorkspace);
      vi.spyOn(fileStore, 'getPlanState').mockResolvedValue(null);

      const scripts = await fileStore.getBuildScripts(mockWorkspaceId, mockPlanId);
      
      expect(scripts).toEqual([]);
    });
  });

  // =========================================================================
  // addBuildScript() - Error handling tests
  // =========================================================================

  describe('addBuildScript()', () => {
    
    it('should throw error when workspace not found', async () => {
      const scriptData = {
        name: 'Test Script',
        description: 'Test',
        command: 'echo test',
        directory: '/test',
      };

      await expect(
        fileStore.addBuildScript('ws_nonexistent', scriptData)
      ).rejects.toThrow('not found');
    });

    it('should throw error when plan not found', async () => {
      const scriptData = {
        name: 'Test Script',
        description: 'Test',
        command: 'echo test',
        directory: '/test',
      };

      await expect(
        fileStore.addBuildScript(mockWorkspaceId, scriptData, 'plan_nonexistent')
      ).rejects.toThrow('not found');
    });
  });

  // =========================================================================
  // BuildScript interface validation
  // =========================================================================

  describe('BuildScript interface', () => {
    
    it('should have required properties', () => {
      const script: BuildScript = {
        id: 'script_001',
        name: 'Test Build',
        description: 'Test description',
        command: 'npm run build',
        directory: '/test/workspace',
        workspace_id: 'ws_test',
        created_at: '2024-01-20T10:00:00Z',
      };

      expect(script.id).toBeDefined();
      expect(script.name).toBeDefined();
      expect(script.command).toBeDefined();
      expect(script.directory).toBeDefined();
      expect(script.workspace_id).toBeDefined();
      expect(script.created_at).toBeDefined();
    });

    it('should support optional plan_id', () => {
      const workspaceScript: BuildScript = {
        id: 'script_ws',
        name: 'Workspace Script',
        description: '',
        command: 'npm run build',
        directory: '/test',
        workspace_id: 'ws_test',
        created_at: '2024-01-20T10:00:00Z',
      };

      const planScript: BuildScript = {
        id: 'script_plan',
        name: 'Plan Script',
        description: '',
        command: 'npm test',
        directory: '/test',
        workspace_id: 'ws_test',
        plan_id: 'plan_123',
        created_at: '2024-01-20T10:00:00Z',
      };

      expect(workspaceScript.plan_id).toBeUndefined();
      expect(planScript.plan_id).toBe('plan_123');
    });
  });
});
