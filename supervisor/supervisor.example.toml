# Project Memory MCP — Supervisor Configuration Reference
# Copy this file to %APPDATA%\ProjectMemory\supervisor.toml and
# adjust paths for your machine, or run .\start-supervisor.ps1 to
# have a working config written automatically.
# For isolated Wave validation (alternate control pipe + runtime env),
# use .\start-supervisor-wave-validation.ps1 at workspace root.
#
# All sections and keys are OPTIONAL — omit anything and the default
# value documented here will be used.

# ── Core supervisor settings ──────────────────────────────────────────────────

[supervisor]
# Minimum log level: trace | debug | info | warn | error
log_level = "info"

# Control-plane transport: named_pipe (Windows default, fastest) | tcp
control_transport = "named_pipe"

# Windows named-pipe path used by the VS Code extension to send control commands
control_pipe = "\\\\.\\pipe\\project-memory-supervisor"

# TCP port for the control API when control_transport = "tcp"
control_tcp_port = 45470

# ── MCP server ───────────────────────────────────────────────────────────────

[mcp]
enabled = true

# Port the MCP server listens on (extension connects here)
port = 3457

# "node" (default) or "container"
backend = "node"

[mcp.node]
command     = "node"
args        = ["dist/server.js"]
# Absolute path to the compiled server directory
working_dir = "C:\\Users\\User\\Project_Memory_MCP\\Project-Memory-MCP\\server"

# Optional supervisor-hosted MCP runtime mode (feature-flagged via env vars):
#   PM_SUPERVISOR_MCP_SUBPROCESS_RUNTIME=1
#   PM_SUPERVISOR_MCP_SUBPROCESS_MAX_CONCURRENCY=4
#   PM_SUPERVISOR_MCP_SUBPROCESS_TIMEOUT_MS=30000
#   PM_SUPERVISOR_MCP_SUBPROCESS_WAVE_COHORTS=wave1,wave2,wave3,wave4
#   PM_SUPERVISOR_MCP_SUBPROCESS_HARD_STOP_GATE=1
#
# Wave 1 validation minimum preconditions:
#   PM_SUPERVISOR_MCP_SUBPROCESS_RUNTIME=1
#   PM_SUPERVISOR_MCP_SUBPROCESS_WAVE_COHORTS=wave1
#   PM_SUPERVISOR_MCP_SUBPROCESS_HARD_STOP_GATE=1
#
# When enabled, the supervisor serves MCP execution via control request
# `McpRuntimeExec` using async subprocess workers instead of starting the
# pool+proxy MCP service.
#
# Wave cohorts + hard-stop gate:
# - `PM_SUPERVISOR_MCP_SUBPROCESS_WAVE_COHORTS` controls which cohorts may
#   execute when hard-stop gating is enabled.
# - `PM_SUPERVISOR_MCP_SUBPROCESS_HARD_STOP_GATE=1` rejects out-of-cohort
#   execution with deterministic `error_class: "hard_stop"` envelopes.
#
# Reviewer isolated-validation shell setup:
#   $env:PM_ORCHESTRATION_SUPERVISOR_PIPE_PATH="\\.\pipe\project-memory-supervisor-wave-validation"
#   # run reviewer validation commands
#   .\stop-supervisor.ps1 -PipeName "project-memory-supervisor-wave-validation"   # isolated teardown; avoids default-instance force-kill
#
# Isolated launcher behavior:
# - .\start-supervisor-wave-validation.ps1 passes PM_SUPERVISOR_* flags using
#   explicit child-process environment overrides (no reliance on parent-shell
#   env inheritance semantics).
# - Its default validation cohort is `wave1` (overridable via -WaveCohorts).

# Environment variables injected into the MCP server process
# [mcp.node.env]
# SOME_VAR = "value"

# Container backend (only used when backend = "container")
[mcp.container]
engine         = "podman"
image          = "project-memory-mcp-project-memory:latest"
container_name = "project-memory-mcp"
ports          = ["3000:3000"]

# ── Interactive Terminal ──────────────────────────────────────────────────────

[interactive_terminal]
enabled = true
port    = 3458

# Full path to the interactive-terminal executable
command = "C:\\Users\\User\\Project_Memory_MCP\\Project-Memory-MCP\\interactive-terminal\\target\\release\\interactive-terminal.exe"

# Optional environment variables injected into interactive-terminal.
# Use this when running coding-subagent sessions against Gemini.
#
# Provider contract (recommended):
#   GEMINI_API_KEY = <your key>
#   GOOGLE_API_KEY = <same key>     # compatibility alias for SDKs/tools
#
# If you launch Supervisor via install.ps1 and your secrets file contains
# PMTA-key=<key>, install.ps1 maps that value to both GEMINI_API_KEY and
# GOOGLE_API_KEY at process launch time (without writing the key to this file).
#
# [interactive_terminal.env]
# GEMINI_API_KEY = "set-in-local-env-not-in-repo"
# GOOGLE_API_KEY = "set-in-local-env-not-in-repo"

# ── Dashboard ────────────────────────────────────────────────────────────────

[dashboard]
enabled      = true
port         = 3459
requires_mcp = true

# Dashboard backend server process (dashboard/server/ — runs Express + WebSocket).
# This is separate from the frontend statics (dashboard/dist/) which are served
# by the VS Code extension's webview panel.
command     = "node"
args        = ["dist/index.js"]
working_dir = "C:\\Users\\User\\Project_Memory_MCP\\Project-Memory-MCP\\dashboard\\server"

# ── Approval gate dialog ──────────────────────────────────────────────────────

[approval]
default_countdown_seconds = 60
default_on_timeout        = "approve"   # "approve" | "reject"
always_on_top             = true

# ── Brainstorm GUI ────────────────────────────────────────────────────────────

[brainstorm_gui]
enabled         = true
command         = "C:\\Users\\User\\Project_Memory_MCP\\Project-Memory-MCP\\target\\release\\pm-brainstorm-gui.exe"
timeout_seconds = 300
window_width    = 720
window_height   = 640
always_on_top   = false

# ── Approval GUI ──────────────────────────────────────────────────────────────

[approval_gui]
enabled         = true
command         = "C:\\Users\\User\\Project_Memory_MCP\\Project-Memory-MCP\\target\\release\\pm-approval-gui.exe"
timeout_seconds = 60
window_width    = 480
window_height   = 320
always_on_top   = true

# ── Reconnect policy (applies to all managed processes) ──────────────────────

[reconnect]
initial_delay_ms = 500
max_delay_ms     = 30000
multiplier       = 2.0
max_attempts     = 0        # 0 = unlimited retries
jitter_ratio     = 0.2

# ── Data-change event broadcast ───────────────────────────────────────────────
# The supervisor maintains an in-process SSE broadcast channel so clients
# (VS Code extension, dashboard, scripts) can subscribe to plan/step changes
# without polling.  Subscribe at GET /supervisor/events.

[events]
enabled            = true   # set false to disable the channel entirely
buffer_size        = 256    # tokio broadcast channel capacity
heartbeat_interval = 30     # seconds between keep-alive pings to SSE clients
replay_buffer_size = 100    # number of past events held for Last-Event-Id replay
